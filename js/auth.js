import{initializeApp}from"https://www.gstatic.com/firebasejs/9.9.4/firebase-app.js";import{getFirestore,doc,collection,addDoc,setDoc,getDoc}from"https://www.gstatic.com/firebasejs/9.9.4/firebase-firestore.js";import{getAuth,updateProfile,applyActionCode,signOut,deleteUser,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,sendEmailVerification,sendPasswordResetEmail,verifyPasswordResetCode,confirmPasswordReset,setPersistence,browserSessionPersistence,inMemoryPersistence}from"https://www.gstatic.com/firebasejs/9.9.4/firebase-auth.js";import{getAnalytics}from"https://www.gstatic.com/firebasejs/9.9.4/firebase-analytics.js";const firebaseConfig={apiKey:"AIzaSyA9HsjfAhwcTsRgoO65nUy0dAGOnBv1he4",authDomain:"kosumigo.firebaseapp.com",projectId:"kosumigo",storageBucket:"kosumigo.appspot.com",messagingSenderId:"837493583764",appId:"1:837493583764:web:34da4cd5541b3bae512981",measurementId:"G-WRXBCFQ1SH"};export{app,db,auth,analytics,userDoc,onAuthStateChanged,signOut};const app=initializeApp(firebaseConfig),db=getFirestore(app),auth=getAuth(app),analytics=getAnalytics();var user;function persistencePromise(a){return new Promise(((e,t)=>{setPersistence(auth,a?inMemoryPersistence:browserSessionPersistence).then((()=>{e()})).catch((a=>{t(a)}))}))}function userDoc(){return getDoc(doc(db,"users",user.uid))}$('[data-auth-role="params-email"]').text(params.get("email")),onAuthStateChanged(auth,(a=>{a?($('[data-auth-role="email"]').text(a.email),params.has("email")||$('[data-auth-role="params-email"]').text(a.email),a.emailVerified?"/dashboard/"!=window.location.pathname&&"/dashboard/reset.html"!=window.location.pathname&&(window.location.href="/dashboard"):"/dashboard/verify.html"!=window.location.pathname&&"/dashboard/signup.html"!=window.location.pathname&&"/dashboard/verified.html"!=window.location.pathname?new Toast("Please verify your email address to access this page","default",1e3,"/img/icon/toast/error-icon.svg","/dashboard/verify.html"):$("[data-auth-role='send-verification']").click((function(){sendEmailVerification(a,{url:"https://kosumigo.github.io/dashboard/"}).then((()=>{$('[data-auth-role="verify-part"').toggle(),new Toast("Verification email sent","default",3e3,"/img/icon/toast/success-icon.svg")})).catch((a=>{new ErrorToast("Could not send verification email",cleanError(a),5e3)}))}))):"/dashboard/login.html"!=window.location.pathname&&"/dashboard/signup.html"!=window.location.pathname&&"/dashboard/forgot-password.html"!=window.location.pathname&&"/dashboard/reset.html"!=window.location.pathname&&"/dashboard/verify.html"!=window.location.pathname&&"/dashboard/verified.html"!=window.location.pathname?new Toast("Sorry, you must be logged in to access this page","default",2e3,"/img/icon/toast/error-icon.svg","./login.html"):"/dashboard/verify.html"==window.location.pathname&&setTimeout((function(){window.location.href="/dashboard"}),2e3)}));const cleanErrors={"auth/invalid-email":"Invalid email","auth/user-disabled":"User disabled","auth/user-not-found":"User not found","auth/wrong-password":"Incorrect password","auth/email-already-in-use":"Email already in use","auth/weak-password":"Password is too weak","auth/operation-not-allowed":"Operation not allowed","auth/too-many-requests":"Too many requests. Please wait before trying again","auth/invalid-credential":"Invalid credential","auth/invalid-verification-code":"Invalid verification code","auth/invalid-verification-id":"Invalid verification ID","auth/missing-verification-code":"Missing verification code","auth/missing-verification-id":"Missing verification ID","auth/credential-already-in-use":"Credential already in use","auth/missing-email":"Email is missing","auth/missing-password":"Password is missing","auth/invalid-action-code":"Invalid action code"};function cleanError(a){return cleanErrors[a.code]?cleanErrors[a.code]:a.message.replace("Error ","")}if($('[data-auth-role="agree-to-terms"]').change((function(){$(this).prop("checked")?$('[data-auth-role="create-account"]').removeClass("disabled"):$('[data-auth-role="create-account"]').addClass("disabled")})),$('[data-auth-role="create-account"').click((function(){let a=$('[data-auth-role="email-input"]').val(),e=$('[data-auth-role="password-input"]').val(),t=$('[data-auth-role="name"]').val();$(this).hasClass("disabled")?new Toast("You must agree to the terms and conditions to create an account","default",5e3,"/img/icon/toast/warning-icon.svg",""):a&&e&&t?createUserWithEmailAndPassword(auth,a,e).then((e=>{user=e.user,setDoc(doc(db,"users",user.uid),{name:t,email:a,uid:user.uid,created:(new Date).getTime()},{merge:!0}).then((()=>{updateProfile(user,{displayName:$('[data-auth-role="name"]').val()}).then((()=>{window.location="/dashboard/verify.html?email="+encodeURIComponent(a)}))})).catch((a=>{new ErrorToast("Error creating user document",cleanError(a),5e3)}))})).catch((a=>{new ErrorToast("Error creating account",cleanError(a),5e3)})):new Toast("Please fill in all fields","default",5e3,"/img/icon/toast/warning-icon.svg","")})),$('[data-auth-role="login"]').click((function(){let a=$('[data-auth-role="email-input"]').val(),e=$('[data-auth-role="password-input"]').val();a&&e?signInWithEmailAndPassword(auth,a,e,{remember:$("[data-auth-role='remember-user']").is(":checked")?null:"sessionOnly"}).then((a=>{user=a.user,window.location="./index.html"})).catch((a=>{new ErrorToast("Error logging in",cleanError(a),5e3)})):new Toast("Please fill in all fields before logging in","default",5e3,"/img/icon/toast/warning-icon.svg","")})),$("[data-auth-role='logoutprompt']").click((function(){new Popup("Are you sure you want to sign out?","default",1e4,"/img/icon/toast/info-icon.svg",[["removePopup()","Cancel","secondary-action fullborder"],["removePopup()","Yes","primary-action data-auth-logout"]])})),$(document.body).on("click","[data-auth-role='logout'], .data-auth-logout",(function(){signOut(auth)})),$("[data-auth-role='to-dashboard']").click((function(){window.location.href="/dashboard/"})),$("[data-auth-role='to-forgot-password']").click((function(){window.location.href="/dashboard/forgot-password.html?reset-email="+encodeURIComponent($('[data-auth-role="email-input"]').val())})),$("[data-auth-role='forgot-password']").click((function(){let a=$('[data-auth-role="email-input"]').val();a&&a.includes("@")?sendPasswordResetEmail(auth,a).then((()=>{$('[data-auth-role="forgot-email"]').text(a),$('[data-auth-role="forgot-password-part"]').toggle(),new Toast("Password reset email sent","default",3e3,"/img/icon/toast/success-icon.svg","")})).catch((a=>{new ErrorToast("Error sending password reset email",cleanError(a),5e3)})):new Toast("Please enter a valid email address","default",5e3,"/img/icon/toast/warning-icon.svg","")})),params.has("reset-email")&&$('[data-auth-role="email-input"], [data-auth-role="reset-src-email"]').val(params.get("reset-email")),"/dashboard/reset.html"==window.location.pathname)if(params.has("oobCode")&&params.has("mode")&&"resetPassword"==params.get("mode")){let a=params.get("oobCode");verifyPasswordResetCode(auth,a).then((e=>{$('[data-auth-role="reset-email"]').text(e),$('[data-auth-role="reset-password"]').click((function(){let t=$('[data-auth-role="password-input"]').val(),o=$('[data-auth-role="confirm-password-input"]').val();t==o?t.match(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\da-zA-Z]).{8,}$/)?confirmPasswordReset(auth,a,t).then((()=>{signInWithEmailAndPassword(auth,e,t).then((()=>{new Toast("Password reset successful. Signed in","default",3e3,"/img/icon/toast/success-icon.svg","/dashboard/")}))})).catch((a=>{new ErrorToast("Error resetting password",cleanError(a),5e3)})):new ErrorToast("Error resetting password","Password must be at least 8 characters, contain upper and lowercase letters, numbers, and symbols",5e3):new ErrorToast("Error resetting password","Passwords do not match",5e3)}))})).catch((a=>{new ErrorToast("Error verifying password reset code",cleanError(a),5e3),setTimeout((()=>{window.location.href="/dashboard/login.html"}),5e3)}))}else new Toast("Invalid password reset code. Returning to login","default",5e3,"/img/icon/toast/warning-icon.svg","/dashboard/login.html");if("/dashboard/verified.html"==window.location.pathname)if(params.has("oobCode")&&params.has("mode")&&"verifyEmail"==params.get("mode")){let a=params.get("oobCode");applyActionCode(auth,a).then((()=>{$('[data-auth-role="verified-part"]').toggle()})).catch((a=>{new ErrorToast("Error verifying email",cleanError(a),5e3)}))}else new Toast("Invalid email verification code. Returning to login","default",5e3,"/img/icon/toast/warning-icon.svg","/dashboard/login.html");$("[data-auth-role='change-email']").click((function(){deleteUser(auth.currentUser).then((()=>{new Toast("Deleted account instance, returning to signup","default",1500,"/img/icon/toast/success-icon.svg","/dashboard/signup.html")})).catch((a=>{new ErrorToast("Error deleting account with current email, signing out instead",cleanError(a),2e3,"/dashboard/signup.html"),setTimeout((()=>{signOut(auth)}),2e3)}))})),$("[data-auth-role='email-input'], [data-auth-role='password-input'], [data-auth-role='confirm-password-input']").on("keypress",(function(a){13==a.which&&(a.preventDefault(),$(this).closest("form, #onboard-container").find("[type='submit'], input[type='button']").click())}));
